{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- 위 3개의 메타 태그는 *반드시* head 태그의 처음에 와야합니다; 어떤 다른 콘텐츠들은 반드시 이 태그들 *다음에* 와야 합니다 -->
	<title>{% block title %}Hi There!{% endblock title %}</title>

	<!-- 부트스트랩 -->
	<!-- <link rel="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"> -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

	<!-- IE8 에서 HTML5 요소와 미디어 쿼리를 위한 HTML5 shim 와 Respond.js -->
	<!-- WARNING: Respond.js 는 당신이 file:// 을 통해 페이지를 볼 때는 동작하지 않습니다. -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <style>
  .red-color {
  	color: red;
  }
  .grey-color {
  	color: #ccc;
  }
  </style>
</head>
<body>
	<div class='container'>
		{% include 'navbar.html' %}
		{% block content %}
		{% endblock content %}

	</div>

	<!-- jQuery (부트스트랩의 자바스크립트 플러그인을 위해 필요합니다) -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>
    function getParameterByName(name, url) {
    if (!url) {
      url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
  }


function loadTweetContainer(tweetContainerID){
  var query = getParameterByName('q')
  var tweetList = [];
  var nextTweetUrl;
  var initialURL = "/api/tweet/";
  var tweetContainer;
  if (tweetContainerID){
    tweetContainer = $("#" + tweetContainerID)
  } else {
    tweetContainer = $("#tweet-container")
  }

  var initialURL = tweetContainer.attr("data-url") || "/api/tweet/";
  console.log(initialURL)


  $(document.body).on("click", ".tweet-like", function(e){
    e.preventDefault()
    var this_ = $(this)
    var tweetId = this_.attr("data-id")
    var likedUrl = '/api/tweet/' + tweetId + "/like/"
    // var heartOn = "<span class='glyphicon glyphicon-heart' aria-hidden='true'></span>"
    // var heartOff = "<span class='glyphicon glyphicon-heart-empty' aria-hidden='true'></span>"

    $.ajax({
      method:"GET",
      url: likedUrl,
      success: function(data){
        if (data.liked){
          this_.text("♥")
        } else {
          this_.text("♡")
        }
      },
      error: function(data){
        console.log("error")
        console.log(data)
      }

    })
  })

  $(document.body).on("click", ".retweetBtn", function(e){

    e.preventDefault()
    console.log("clicked")
    var url = "/api" + $(this).attr("href")
 
    $.ajax({
      method: "GET",
      url: url,
      success: function (data) {
        console.log(data)
        if (initialURL == "/api/tweet/") {
          attachTweet(data, true, true)
          updateHashLinks()
        }

      },
      error: function(data){
        console.log("error")
        console.log(data)
      }
    })
  })
  function updateHashLinks(){
    $(".media-body").each(function(data){
        var hashtagRegex = /(^|\s)#([\w\d-]+)/g
        var usernameRegex = /(^|\s)@([\w\d-]+)/g
        var currentHtml = $(this).html()
        var newText;
        newText = currentHtml.replace(hashtagRegex, "$1<a href='/tags/$2/'>#$2</a>")
        newText = newText.replace(usernameRegex, "$1 @<a href='/$2/'>$2</a>")
        $(this).html(newText)
    })
  }

  function attachTweet(tweetValue, prepend, retweet){
      var dateDisplay = tweetValue.date_display;
      var tweetContent = tweetValue.content;
      var tweetUser = tweetValue.user;
      var tweetFormattedHtml;
      var verb = "<span class='glyphicon glyphicon-heart-empty' aria-hidden='true'></span>"
      if (tweetValue.did_like){
        verb = "<span class='glyphicon glyphicon-heart' aria-hidden='true'></span>"
      }




      if (retweet && tweetValue.parent){
         // retweet
        var mainTweet = tweetValue.parent
         tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\"><span class='grey-color'>Retweet via " + tweetUser.username +" on " + dateDisplay + "</span><br/>"+ mainTweet.content + "<br/> via <a href='" + mainTweet.user.url + "'>" + mainTweet.user.username + "</a> | " + mainTweet.date_display + " | " + "<a href='/tweet/" + mainTweet.id + "'>View</a> | " + "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet/'>Retweet</a>" + " | <a href='#' class='tweet-like' data-id=" + tweetValue.id + ">" + verb + " (" + tweetValue.likes + ")</a></div></div><hr/>"
      } else {
        // fresh tweet
         tweetFormattedHtml = "<div class=\"media\"><div class=\"media-body\">" + tweetContent + "<br/> via <a href='" + tweetUser.url + "'>" + tweetUser.username + "</a> | " + dateDisplay + " | " + "<a href='/tweet/" + tweetValue.id + "'>View</a> | " + "<a class='retweetBtn' href='/tweet/" + tweetValue.id + "/retweet/'>Retweet</a>" + " | <a href='#' class='tweet-like' data-id=" + tweetValue.id + ">" + verb + " (" + tweetValue.likes + ")</a></div></div><hr/>"
      }
      
      if (prepend==true){
        tweetContainer.prepend(tweetFormattedHtml)
      } else {
        tweetContainer.append(tweetFormattedHtml)
     }
  }

  function parseTweets(){
    if (tweetList == 0) {
      tweetContainer.text("No tweets currently found.")
    } else {
      // tweets exist, parse & display them
     $.each(tweetList, function(key, value){
          var tweetKey = key;
          if (value.parent) {
            attachTweet(value, false, true)
          } else {
            attachTweet(value)
          }
          
      })
    }
  }

  function fetchTweets(url){
    console.log('fetching')
    var fecthUrl;
    if (!url) {
      fecthUrl = initialURL
    } else {
      fecthUrl = url
    }
    $.ajax({
      url: fecthUrl,
      data: {
        "q": query
      },
      method: "GET",
      success: function(data){
        // console.log(data)
        tweetList = data.results
        if (data.next){
          nextTweetUrl = data.next
        } else {
          $("#loadmore").css("display", "none")
        }
        parseTweets()
        updateHashLinks()
       
      },
      error: function(data){
        console.log("error")
        console.log(data)
      }
    })
  }

  fetchTweets()


  $("#loadmore").click(function(event){
      event.preventDefault()
      if (nextTweetUrl) {
        fetchTweets(nextTweetUrl)
      }
      // load more items
  })
  
  var charsStart = 140;
  var charsCurrent = 0;

  $("#tweet-form").append("<span id='tweetCharsLeft'>" + charsStart + "</span>")

  $("#tweet-form textarea").keyup(function(event){
      var tweetValue = $(this).val()
      charsCurrent = charsStart - tweetValue.length
      var spanChars = $("#tweetCharsLeft")
      spanChars.text(charsCurrent)

      if (charsCurrent > 0 ) {
         // remove classes
         spanChars.removeClass("grey-color")
         spanChars.removeClass("red-color")
      } else if (charsCurrent == 0) {
         // add grey class
         spanChars.removeClass("red-color")
         spanChars.addClass("grey-color")
      } else if (charsCurrent < 0) {
          // add red class
          spanChars.removeClass("grey-color")
          spanChars.addClass("red-color")
      }

  })

  $("#tweet-form").submit(function(event){
      event.preventDefault()
      var this_ = $(this)
      var formData =  this_.serialize()
      if (charsCurrent >= 0) {
        $.ajax({
          url: "/api/tweet/create/",
          data: formData,
          method: "POST",
          success: function(data){
            this_.find("input[type=text], textarea").val("")
            attachTweet(data, true)
            updateHashLinks()
           
          },
          error: function(data){
            console.log("error")
            console.log(data.statusText)
            console.log(data.status)
          }
        })
      }  else {
        console.log("Cannot send, tweet too long.")
    }



      
  })
}

    </script>

	{% block script %}{% endblock script %}

    <script>
      $(document).ready(function(){
        var typingTimer;
        var doneInterval = 800;
        var searchInput = $("#navbar-search-form input[type=text]")
        var searchQuery;

        searchInput.keyup(function(event){
            searchQuery =  $(this).val()
            clearTimeout(typingTimer)
            typingTimer = setTimeout(doneSearchTyping, doneInterval)
            
        })

         searchInput.keydown(function(event){
            clearTimeout(typingTimer)  
        })

        function doneSearchTyping(){
          if (searchQuery){
            var url = '/tweet/search/?q=' + searchQuery
            document.location.href = url;
          }
        }


      })
  </script>


	<!-- 모든 컴파일된 플러그인을 포함합니다 (아래), 원하지 않는다면 필요한 각각의 파일을 포함하세요 -->
	<!-- <script src="{% static 'js/bootstrap.min.js' %}"></script> -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
</body>
</html>